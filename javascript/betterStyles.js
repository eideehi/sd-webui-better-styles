(function(){"use strict";const ot="";function i(e,...t){const n=getTranslation(e)||e;return t.length===0?n:t.reduce((s,c,a)=>s.replace(`{${a}}`,c),n)}function h(e){return gradioApp().querySelector(e)}function ne(e){return!!h(e)}function T(e){return Array.from(gradioApp().querySelectorAll(e))}function R(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function P(e,t,...n){t?e.classList.add(...n):e.classList.remove(...n)}function Ue(e,...t){t.forEach(n=>{e.classList.toggle(n)})}function p(e,t){e==null||e.classList.toggle("better-styles-force-hidden",t)}function Re(e,t){const n=opts[e];typeof n=="boolean"&&t(n)}function se(e){const t=h(`#${e}_gallery > div > img`);if(!(t instanceof HTMLImageElement))return k();const n=()=>t.src.substring(t.src.indexOf("file=")+5);return{get:n,getOrDefault:n,with:s=>s(n())}}function V(){const e=h("#sd_checkpoint_hash");if(!(e instanceof HTMLAnchorElement))return k();const t=()=>e.title;return{get:t,getOrDefault:t,with:n=>n(t())}}function ie(e){return ye(`#${e}_prompt textarea`)}function ce(e){return ye(`#${e}_neg_prompt textarea`)}function ae(e){return Se(`#${e}_sampling select`)}function le(e){return x(`#${e}_steps input[type='number']`)}function oe(e){return x(`#${e}_cfg_scale input[type='number']`)}function re(e){return x(`#${e}_seed input[type='number']`)}function de(e){return q(`#${e}_restore_faces input[type='checkbox']`)}function ue(e){return q(`#${e}_tiling input[type='checkbox']`)}function pe(e){return q(`#${e}_enable_hr input[type='checkbox']`)}function me(e){return Se(`#${e}_hr_upscaler select`)}function he(e){return x(`#${e}_hires_steps input[type='number']`)}function fe(e){return x(`#${e}_denoising_strength input[type='number']`)}function ge(e){return x(`#${e}_hr_scale input[type='number']`)}function ve(){return x("#setting_CLIP_stop_at_last_layers input[type='number']")}function Ce(){return x("#setting_eta_noise_seed_delta input[type='number']")}function B(e,t){if(t==="input")updateInput(e);else if(t==="change"){const n=new Event(t);Object.defineProperty(n,"target",{value:e}),e.dispatchEvent(n)}}function _(){const e=get_uiCurrentTabContent();if(e==null)return"other";const{id:t}=e;if(t.startsWith("tab_")){const n=t.slice(4);switch(n){case"txt2img":case"img2img":return n}}return"other"}function k(){return{get:()=>null,getOrDefault:e=>e,with:()=>{},set:()=>!1}}function b(e){return{...e,getOrDefault:()=>e.get(),with:t=>t(e.get())}}function ye(e){const t=h(e);return t instanceof HTMLTextAreaElement?b({get:()=>t.value,set:n=>(t.value=n,B(t,"input"),!0)}):k()}function Se(e){const t=h(e);return t instanceof HTMLSelectElement?{index:b({get:()=>t.selectedIndex,set:n=>(t.selectedIndex=n,B(t,"change"),!0)}),value:b({get:()=>{var n;return((n=t.selectedOptions[0])==null?void 0:n.value)||""},set:n=>{const s=t.querySelector(`option[value='${n}']`);let c=-1;return s instanceof HTMLOptionElement&&(c=s.index),c>=0?(t.selectedIndex=c,B(t,"change"),!0):!1}})}:{index:k(),value:k()}}function x(e){const t=h(e);return t instanceof HTMLInputElement?b({get:()=>t.valueAsNumber,set:n=>(t.valueAsNumber=n,B(t,"input"),!0)}):k()}function q(e){const t=h(e);return t instanceof HTMLInputElement?b({get:()=>t.checked,set:n=>(t.checked!=n&&t.click(),!0)}):k()}const Ve=/,(\s+)?$/g,qe=/^(\s+)?,/g;function be(e,t){return!e||Ve.test(e)||qe.test(t)?e+t:`${e}, ${t}`}function ze(e,t){if(t.prompt){const n=ie(e);n.set(be(n.getOrDefault(""),t.prompt))}if(t.negativePrompt){const n=ce(e);n.set(be(n.getOrDefault(""),t.negativePrompt))}t.samplingMethod&&ae(e).value.set(t.samplingMethod),t.samplingSteps&&le(e).set(t.samplingSteps),t.cfgScale&&oe(e).set(t.cfgScale),t.seed&&re(e).set(t.seed),t.restoreFaces&&de(e).set(t.restoreFaces),t.tiling&&ue(e).set(t.tiling),t.hiresFix&&pe(e).set(t.hiresFix),t.upscaler&&me(e).value.set(t.upscaler),t.hiresSteps&&he(e).set(t.hiresSteps),t.denoisingStrength&&fe(e).set(t.denoisingStrength),t.upscaleBy&&ge(e).set(t.upscaleBy),t.clipSkip&&ve().set(t.clipSkip),t.etaNoiseSeedDelta&&Ce().set(t.etaNoiseSeedDelta)}function Ee(e,t){fetch("/better-style-api/v1/register-style",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)}).then(n=>n.json()).then(n=>{t(n)})}function Je(e,t){fetch("/better-style-api/v1/delete-styles",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)}).then(n=>n.json()).then(n=>{t(n)})}let S=null,D=-1;function Xe(){return S||(S=document.createElement("div"),S.classList.add("better-styles","toast"),S.addEventListener("click",()=>{z()}),gradioApp().appendChild(S),S)}function A(e,t="info",n=3e3){z();const s=Xe();s.classList.remove("toast-info","toast-success","toast-warning","toast-error"),s.classList.add(`toast-${t}`),s.textContent=e,D=setTimeout(()=>{s.classList.remove("fade-out"),s.classList.add("show"),D=setTimeout(()=>{s.classList.remove("show"),s.classList.add("fade-out"),D=setTimeout(()=>{z()},300)},n)},50)}function z(){D>=0&&clearTimeout(D),S&&(gradioApp().removeChild(S),S=null)}let Le=[];const $=b({get:()=>Le,set:e=>(Le=[...e],!0)});let xe="";const ke=b({get:()=>xe,set:e=>(xe=e,!0)});let we="";const _e=b({get:()=>we,set:e=>(we=e,!0)});let $e="default";const v=b({get:()=>$e,set:e=>($e=e,!0)});let g=null,E;function Ye(){if(g){P(g,ne(".gradio-container.dark"),"dark"),R(E);return}g=document.createElement("div"),g.id="better-styles-modal",p(g,!0),g.classList.add("better-styles","modal"),g.addEventListener("mousedown",e=>{e.target===g&&e.button===0&&(e.preventDefault(),p(g,!0))}),gradioApp().appendChild(g),E=document.createElement("div"),E.classList.add("content-wrapper"),g.appendChild(E),P(g,ne(".gradio-container.dark"),"dark")}function J(e){Ye(),E.appendChild(e),p(g,!1)}function O(e){E!=null&&E.removeChild(e)&&p(g,!E.hasChildNodes())}function Ke(){const e=_();if(e==="other")return;const t=Qe(e),n=document.createElement("div");n.classList.add("save-style","modal-content");const s=document.createElement("div");s.classList.add("input-fields"),n.appendChild(s);const c=Te(i("Style name"),"");s.appendChild(c.element);const a=Te(i("Group"),i(v.getOrDefault("default")));s.appendChild(a.element);const o=De(i("Prompt"),t.prompt||"");s.appendChild(o.element);const l=De(i("Negative prompt"),t.negativePrompt||"");s.appendChild(l.element);const d=document.createElement("div");d.classList.add("parameters"),n.appendChild(d);const m=document.createElement("span");m.classList.add("label"),m.textContent=i("Save these parameters as style"),d.appendChild(m);const r=document.createElement("ul");r.classList.add("parameter-fields"),d.appendChild(r);const C=f(i("Sampling method"));r.appendChild(C.element);const y=f(i("Sampling steps"));r.appendChild(y.element);const w=f(i("CFG Scale"));r.appendChild(w.element);const M=f(i("Seed"));r.appendChild(M.element);const Ie=f(i("Restore faces"));r.appendChild(Ie.element);const Ge=f(i("Tiling"));r.appendChild(Ge.element);const He=f(i("Hires. fix"));r.appendChild(He.element);const K=f(i("Upscaler"));r.appendChild(K.element);const Q=f(i("Hires steps"));r.appendChild(Q.element);const W=f(i("Denoising strength"));r.appendChild(W.element);const Z=f(i("Upscale by"));r.appendChild(Z.element),t.hiresFix||(p(K.element,!0),p(Q.element,!0),p(W.element,!0),p(Z.element,!0));const N=f(i("Clip skip"));r.appendChild(N.element);const ee=f(i("Eta noise seed delta"));r.appendChild(ee.element),t.clipSkip==null&&p(N.element,!0),t.etaNoiseSeedDelta==null&&p(ee.element,!0);const I=document.createElement("div");I.classList.add("other-options"),n.appendChild(I);const je=f(i("Make this style exclusive to the current checkpoint"));I.appendChild(je.element);const G=f(i("Use the current image as a thumbnail"));t.image||(G.element.classList.add("disabled"),G.input.disabled=!0),I.appendChild(G.element);const H=document.createElement("div");H.classList.add("buttons"),n.appendChild(H);const lt=()=>{const u={};return je.input.checked&&(u.checkpoint=t.checkpoint),G.input.checked&&(u.image=t.image),o.textarea.value&&(u.prompt=o.textarea.value),l.textarea.value&&(u.negativePrompt=l.textarea.value),C.input.checked&&(u.samplingMethod=t.samplingMethod),y.input.checked&&(u.samplingSteps=t.samplingSteps),w.input.checked&&(u.cfgScale=t.cfgScale),M.input.checked&&(u.seed=t.seed),Ie.input.checked&&(u.restoreFaces=t.restoreFaces),Ge.input.checked&&(u.tiling=t.tiling),He.input.checked&&(u.hiresFix=t.hiresFix),K.input.checked&&(u.upscaler=t.upscaler),Q.input.checked&&(u.hiresSteps=t.hiresSteps),W.input.checked&&(u.denoisingStrength=t.denoisingStrength),Z.input.checked&&(u.upscaleBy=t.upscaleBy),N.input.checked&&(u.clipSkip=t.clipSkip),ee.input.checked&&(u.etaNoiseSeedDelta=t.etaNoiseSeedDelta),u},L=document.createElement("button");L.classList.add("save-button","button","lg","primary"),L.textContent=i("Save with this content"),L.addEventListener("click",()=>{Ee({group:(U=>U===i("default")?"default":U)(a.input.value),style:{name:c.input.value,...lt()}},U=>{O(n),$.set(U),X(),A(i("Style registered"),"success")})}),H.appendChild(L);const j=document.createElement("button");j.classList.add("button","lg","secondary"),j.textContent=i("Close without saving"),j.addEventListener("click",()=>{O(n)}),H.appendChild(j);const te=()=>{const u=!c.input.value||!a.input.value;L.disabled=u,u?(L.classList.remove("gr-button","gr-button-primary"),L.classList.add("gr-box","gr-check-radio")):(L.classList.remove("gr-box","gr-check-radio"),L.classList.add("gr-button","gr-button-primary"))};te(),c.input.addEventListener("input",()=>{te()}),a.input.addEventListener("input",()=>{te()}),J(n)}const Te=(e,t)=>{const n=document.createElement("label");n.classList.add("input-field");const s=document.createElement("span");s.classList.add("label"),s.textContent=e;const c=document.createElement("textarea");return c.classList.add("text-input","scroll-hide"),c.rows=1,c.value=t,n.appendChild(s),n.appendChild(c),{element:n,input:c}},De=(e,t)=>{const n=document.createElement("label");n.classList.add("input-field");const s=document.createElement("span");s.classList.add("label"),s.textContent=e;const c=document.createElement("textarea");return c.classList.add("text-input","scroll-hide"),c.rows=3,c.value=t,n.appendChild(s),n.appendChild(c),{element:n,textarea:c}},f=e=>{const t=document.createElement("label");t.classList.add("checkbox-wrapper");const n=document.createElement("input");n.type="checkbox",n.addEventListener("change",()=>{t.dataset.checked=String(n.checked)});const s=document.createElement("span");return s.classList.add("label"),s.textContent=e,t.appendChild(n),n.after(s),{element:t,input:n}};function Qe(e){const t={};return se(e).with(n=>t.image=n),V().with(n=>t.checkpoint=n),ie(e).with(n=>t.prompt=n),ce(e).with(n=>t.negativePrompt=n),ae(e).value.with(n=>t.samplingMethod=n),le(e).with(n=>t.samplingSteps=n),oe(e).with(n=>t.cfgScale=n),re(e).with(n=>t.seed=n),de(e).with(n=>t.restoreFaces=n),ue(e).with(n=>t.tiling=n),pe(e).with(n=>t.hiresFix=n),me(e).value.with(n=>t.upscaler=n),he(e).with(n=>t.hiresSteps=n),fe(e).with(n=>t.denoisingStrength=n),ge(e).with(n=>t.upscaleBy=n),ve().with(n=>t.clipSkip=n),Ce().with(n=>t.etaNoiseSeedDelta=n),t}function We(e){const t=document.createElement("div");t.classList.add("save-style","modal-content"),t.style.width="clamp(20rem, 70vw, 42.5rem)",t.style.boxShadow="0px 0px 4px 0.25rem rgb(8 8 8 / 50%)";const n=document.createElement("p");n.classList.add("text"),n.textContent=i("Delete all selected styles. This action cannot be undone. Are you sure?"),t.appendChild(n);const s=document.createElement("div");s.classList.add("button-container"),t.appendChild(s);const c=document.createElement("button");c.classList.add("button","lg","primary"),c.textContent=i("Execute the deletion"),c.addEventListener("click",()=>{const o=T(`#better-styles-${e}-style-container .selected`);Je({group:v.getOrDefault(""),styles:[...o.map(l=>l.dataset.style||"").filter(l=>l.length>0)]},l=>{O(t),$.set(l),X(),A(i("Styles deleted"),"success")})}),s.appendChild(c);const a=document.createElement("button");a.classList.add("button","lg","secondary"),a.textContent=i("Close without deleting"),a.addEventListener("click",()=>{O(t)}),s.appendChild(a),J(t)}const Ze=e=>{var a,o,l,d,m,r,C,y;const t=document.createElement("div");t.classList.add("styles-detail","modal-content");const n=document.createElement("div");n.classList.add("field-container"),t.appendChild(n),[{label:i("Style name"),value:i(e.name)},{label:i("Exclusive"),value:e.checkpoint?i("Yes"):i("No")},{label:i("Prompt"),value:e.prompt},{label:i("Negative prompt"),value:e.negativePrompt},{label:i("Sampling method"),value:e.samplingMethod},{label:i("Sampling steps"),value:(a=e.samplingSteps)==null?void 0:a.toString()},{label:i("CFG Scale"),value:(o=e.cfgScale)==null?void 0:o.toString()},{label:i("Seed"),value:(l=e.seed)==null?void 0:l.toString()},{label:i("Restore faces"),value:e.restoreFaces?i("Enabled"):void 0},{label:i("Tiling"),value:e.tiling?i("Enabled"):void 0},{label:i("Hires. fix"),value:e.hiresFix?i("Enabled"):void 0},{label:i("Upscaler"),value:e.upscaler},{label:i("Hires steps"),value:(d=e.hiresSteps)==null?void 0:d.toString()},{label:i("Denoising strength"),value:(m=e.denoisingStrength)==null?void 0:m.toString()},{label:i("Upscale by"),value:(r=e.upscaleBy)==null?void 0:r.toString()},{label:i("Clip skip"),value:(C=e.clipSkip)==null?void 0:C.toString()},{label:i("Eta noise seed delta"),value:(y=e.etaNoiseSeedDelta)==null?void 0:y.toString()}].forEach(({label:w,value:M})=>{M!=null&&n.appendChild(Ne(w,M))});const c=document.createElement("button");c.classList.add("button","lg","secondary"),c.textContent=i("Close style detail"),c.addEventListener("click",()=>{O(t)}),t.appendChild(c),J(t)},Ne=(e,t)=>{const n=document.createElement("div");n.classList.add("field");const s=document.createElement("span");s.textContent=e,s.classList.add("label"),n.appendChild(s);const c=document.createElement("p");return c.textContent=t,c.classList.add("value"),n.appendChild(c),n};let Ae=!1;function X(){const e=_();e!=="other"&&(_e.set(`?ts=${new Date().getTime()}`),F(e))}function et(e){var d,m;if(h(`#better-styles-${e}-styles`))return;const t=document.createElement("div");t.id=`better-styles-${e}-styles`,p(t,!0),t.classList.add("better-styles","form"),(m=(d=h(`div#${e}_settings`))==null?void 0:d.parentElement)==null||m.before(t);const n=document.createElement("div");n.classList.add("compact","gradio-row"),t.appendChild(n);const s=document.createElement("div");s.classList.add("tabs","gradio-tabs","extra-networks"),n.appendChild(s);const c=nt(e);s.appendChild(c);const a=document.createElement("div");a.classList.add("tab-item"),s.appendChild(a);const o=document.createElement("div");o.id=`better-styles-${e}-group-container`,o.classList.add("group-container"),a.appendChild(o),o.appendChild(Y("default")),Oe(e);const l=document.createElement("div");if(l.id=`better-styles-${e}-style-container`,l.classList.add("styles-cards"),a.appendChild(l),l.appendChild(Me()),!Ae){Ae=!0;let r=V().get();const C=()=>{const y=_();if(y!=="other"){const w=V().get();w!==r&&(r=w,F(y))}setTimeout(C,500)};setTimeout(C,500)}tt(e,t)}function tt(e,t){var s;const n=h(`#${e}_style_apply`);if(n){const c=document.createElement("button");c.id=`better-styles-${e}-toggle`,c.textContent="ðŸ”–",c.classList.add(...Array.from(n.classList)),p(c,!1),c.title=i("Show Better Styles"),c.addEventListener("click",()=>{p(t)}),(s=n.parentElement)==null||s.appendChild(c)}}function nt(e){const t=document.createElement("div");t.classList.add("tab-nav","scroll-hide");const n=document.createElement("p");n.classList.add("label"),n.textContent=i("Better Styles"),t.appendChild(n);const s=document.createElement("textarea");s.classList.add("text-input","scroll-hide","search"),s.placeholder=i("Search styles..."),s.rows=1,s.addEventListener("input",()=>{T(`#better-styles-${e}-style-container [data-style]`).forEach(d=>{const m=d.dataset.style||"";p(d,!m.includes(s.value))})}),n.after(s);const c=document.createElement("button");c.id=`better-styles-${e}-apply`,c.classList.add("button","lg","secondary"),c.textContent=i("Apply style"),c.addEventListener("click",()=>{const d=[...T(`#better-styles-${e}-style-container .selected`)];if(d.length<=0){A(i("Style is not selected"),"warning");return}d.filter(m=>{const r=m.dataset.style;return $.getOrDefault([]).filter(C=>C.name===v.get()).some(C=>C.styles.filter(y=>y.name===r).some(y=>(ze(e,y),!0)))}).forEach(m=>m.click())}),s.after(c);const a=document.createElement("button");a.id=`better-styles-${e}-save`,a.classList.add("button","lg","secondary"),a.textContent=i("Save style"),a.addEventListener("click",()=>{Ke()}),c.after(a);const o=document.createElement("button");o.id=`better-styles-${e}-delete`,o.classList.add("button","lg","secondary"),o.textContent=i("Delete style"),o.addEventListener("click",()=>{if([...T(`#better-styles-${e}-style-container .selected`)].length<=0){A(i("Style is not selected"),"warning");return}We(e)}),a.after(o);const l=document.createElement("button");return l.id=`better-styles-${e}-close`,l.classList.add("button","lg","secondary"),l.textContent=i("Close Better Styles"),l.addEventListener("click",()=>{p(h(`#better-styles-${e}-styles`),!0)}),o.after(l),t}function Y(e){const t=document.createElement("button");return t.classList.add("button","lg","secondary","custom-button"),t.textContent=i(e),t.dataset.group=e,e===v.get()&&(t.disabled=!0),t.addEventListener("click",()=>{v.set(e);const n=_();n!=="other"&&F(n)}),t}function Oe(e){T(`#better-styles-${e}-group-container > button`).forEach(t=>{const n=t.dataset.group===v.get();P(t,n,"gr-button-primary"),P(t,!n,"gr-button-secondary"),t instanceof HTMLInputElement&&(t.disabled=n)})}function Me(){const e=document.createElement("div");e.classList.add("no-cards");const t=document.createElement("p");return t.textContent=i('Style not yet registered. "Save style" button for register a new style.'),e.appendChild(t),e}function F(e){var a;const t=h(`#better-styles-${e}-group-container`),n=h(`#better-styles-${e}-style-container`);if(!t||!n)return;R(t),R(n);const s=((a=h("#sd_checkpoint_hash"))==null?void 0:a.title)||"",c=st(s);c.some(({styles:o})=>o.length>0)?c.sort((o,l)=>o.name.localeCompare(l.name)).forEach(o=>{v.get()===""&&v.set(o.name),t.appendChild(Y(o.name)),o.name===v.get()&&o.styles.sort((l,d)=>l.name.localeCompare(d.name)).forEach(l=>{n.appendChild(it(l))})}):(v.set("default"),t.appendChild(Y("default")),n.appendChild(Me())),Oe(e)}function st(e){const t=[];let n=!1;return $.getOrDefault([]).forEach(s=>{const c=s.styles.filter(a=>!a.checkpoint||e===a.checkpoint);c.length>0?t.push({name:s.name,styles:c}):s.name===v.get()&&(n=!0)}),n&&v.set(""),t}function it(e){const t=document.createElement("div");t.dataset.style=e.name,t.classList.add("card");const n=document.createElement("button");n.classList.add("show-detail-button"),n.title=i("Show styles detail"),n.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),Ze(e)}),t.appendChild(n);const s=document.createElement("img");s.classList.add("image"),s.setAttribute("draggable","false"),e.image?s.src=`file=${ke.get()}/${e.image}${_e.get()}`:s.src="file=html/card-no-preview.png",t.appendChild(s);const c=document.createElement("div");c.classList.add("actions"),t.appendChild(c);const a=document.createElement("a");a.classList.add("replace-preview"),a.href="#",a.text=i("replace thumbnail"),a.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();const d=_();if(d==="other")throw new Error("Calls from non-valid tabs");const m=se(d);if(m.get()==null){A(i("Image is not selected"),"warning");return}Ee({group:v.getOrDefault("default"),style:{...e,image:m.getOrDefault("")}},r=>{$.set(r),X()})}),c.appendChild(a);const o=document.createElement("span");return o.classList.add("label"),o.textContent=e.name,o.title=e.name,c.appendChild(o),t.addEventListener("click",()=>{Ue(t,"selected")}),t}let Pe=null,Be=null,Fe=null;onUiLoaded(()=>{const e=new Date().getTime();Pe=fetch(`/better-style-api/v1/get-localization?ts=${e}`).then(t=>t.json()).then(t=>(Object.assign(localization,t),Promise.resolve())),Fe=fetch(`/better-style-api/v1/images-dir?ts=${e}`).then(t=>t.json()).then(t=>(ke.set(t.imagesDir),Promise.resolve())),Be=fetch(`/better-style-api/v1/all-style?ts=${e}`).then(t=>t.json()).then(t=>($.set(t),Promise.resolve()))}),onUiTabChange(()=>{const e=_();e!=="other"&&ct(e)});function ct(e){at(e),Promise.all([Pe]).then(()=>{et(e)}),Promise.all([Fe,Be]).then(()=>{F(e)})}function at(e){Re("better_styles_hide_original_styles",t=>{t&&(p(h(`#${e}_style_apply`),!0),p(h(`#${e}_style_create`),!0),p(h(`#${e}_styles_row`),!0))})}})();
